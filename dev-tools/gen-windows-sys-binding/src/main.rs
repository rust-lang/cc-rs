//! Adapted from
//! https://github.com/rust-lang/rust/blob/master/src/tools/generate-windows-sys/src/main.rs

use std::{
    fs,
    io::{self, Read, Write},
};

/// This is printed to the file before the rest of the contents.
const PRELUDE: &str = r#"// This file is autogenerated.
//
// To add bindings, edit windows_sys.lst then run:
//
// ```
// cd generate-windows-sys/
// cargo run
// ```
"#;

fn main() -> io::Result<()> {
    let manifest_dir = env!("CARGO_MANIFEST_DIR");
    let temp_file = tempfile::Builder::new()
        .suffix(".rs")
        .tempfile()
        .expect("failed to create temp file");

    // Common args to windows_bindgen.
    let mut args = vec![
        "--config",
        "std",
        "flatten",
        "--out",
        temp_file.path().to_str().unwrap(),
        "--filter",
    ];

    // Append the list of APIs
    let buffer = fs::read_to_string(format!("{manifest_dir}/windows_sys.list"))
        .expect("failed to read list");
    args.extend(buffer.lines().filter_map(|line| {
        let line = line.trim();
        if line.is_empty() || line.starts_with("//") {
            None
        } else {
            Some(line)
        }
    }));

    // Generate bindings.
    windows_bindgen::bindgen(&args).expect("running bindgen failed");

    let mut bindings = String::new();
    fs::File::open(temp_file.path())
        .expect("failed to open temp windows_sys.rs")
        .read_to_string(&mut bindings)
        .expect("failed to read temp windows_sys.rs");

    let mut f = fs::File::create(format!("{manifest_dir}/../../src/windows/windows_sys.rs"))
        .expect("failed to create windows_sys.rs");
    f.write_all(PRELUDE.as_bytes())?;
    f.write_all(bindings.as_bytes())?;

    Ok(())
}
